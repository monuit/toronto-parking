# Railway build configuration using Nixpacks
# Must include Node.js explicitly alongside Python

[phases.setup]
nixPkgs = ["python3", "nodejs_22", "npm", "postgresql_16.dev", "gcc"]

[phases.install]
cmds = [
  "python -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate && pip install -r requirements.txt"
]

[phases.build]
cmds = [
  "cd map-app && npm ci --include=dev && npm run build:ssr",
  "cd tools/pmtiles && npm ci"
]

[start]
cmd = "node scripts/start-app-with-worker.mjs"

[variables]
MAP_APP_MAX_HEAP_MB = "3072"
NODE_OPTIONS = "--optimize-for-size --expose-gc"
