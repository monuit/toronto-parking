[phases.setup]
nixPkgs = ['nodejs_20', 'curl']

[phases.install]
cmds = [
  # Create data directory
  'mkdir -p map-app/public/data',
  
  # Download tickets_aggregated.geojson from MinIO using public endpoint with auth
  'curl -f -u "${MINIO_ROOT_USER}:${MINIO_ROOT_PASSWORD}" "https://${MINIO_PUBLIC_HOST}/to-parking/tickets_aggregated.geojson" -o map-app/public/data/tickets_aggregated.geojson',
  
  # Verify file was downloaded
  'test -s map-app/public/data/tickets_aggregated.geojson || (echo "Failed to download tickets_aggregated.geojson from MinIO" && exit 1)',
  
  'cd map-app && npm ci'
]

[phases.build]
cmds = ['cd map-app && npm run build:ssr']

[start]
cmd = 'cd map-app && npm start'
